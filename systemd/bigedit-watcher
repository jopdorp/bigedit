#!/bin/bash
# bigedit-watcher: Watch for bigedit journal files and auto-mount FUSE views
#
# This script monitors the filesystem for .bigedit-journal files and
# automatically starts FUSE mounts for them so the patched content
# is always accessible.

set -e

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/bigedit"
STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/bigedit"
WATCH_DIRS_FILE="$CONFIG_DIR/watch-dirs"
MOUNTS_FILE="$STATE_DIR/active-mounts"

mkdir -p "$CONFIG_DIR" "$STATE_DIR"

# Default watch directories
if [ ! -f "$WATCH_DIRS_FILE" ]; then
    echo "$HOME" > "$WATCH_DIRS_FILE"
fi

# Track active mounts
touch "$MOUNTS_FILE"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

# Start FUSE mount for a journal file
start_mount() {
    local journal_file="$1"
    local dir=$(dirname "$journal_file")
    
    # Journal file is .filename.bigedit-journal, extract original filename
    local journal_basename=$(basename "$journal_file")
    # Remove .bigedit-journal suffix first, then remove leading dot
    local base="${journal_basename%.bigedit-journal}"
    base="${base#.}"  # Remove leading dot from basename
    
    local original_file="$dir/$base"
    
    if [ ! -f "$original_file" ]; then
        log "Original file not found: $original_file"
        return
    fi
    
    local mount_point="$dir/.$base.view"
    local pid_file="$dir/.$base.bigedit-fuse.pid"
    
    # Check if already mounted
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            log "Already mounted: $original_file"
            return
        fi
    fi
    
    log "Starting FUSE mount for: $original_file"
    bigedit-fuse "$original_file" &
    
    # Record mount
    echo "$original_file" >> "$MOUNTS_FILE"
}

# Stop FUSE mount for a file
stop_mount() {
    local original_file="$1"
    local dir=$(dirname "$original_file")
    local base=$(basename "$original_file")
    local pid_file="$dir/.$base.bigedit-fuse.pid"
    local mount_point="$dir/.$base.view"
    local symlink="$dir/$base.edited"
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        log "Stopping FUSE mount for: $original_file (PID $pid)"
        kill -TERM "$pid" 2>/dev/null || true
        sleep 0.5
        # Cross-platform unmount
        if [ "$(uname)" = "Darwin" ]; then
            umount "$mount_point" 2>/dev/null || true
        else
            fusermount3 -u "$mount_point" 2>/dev/null || fusermount -u "$mount_point" 2>/dev/null || true
        fi
        rm -f "$pid_file"
        rm -f "$symlink" 2>/dev/null || true
        rmdir "$mount_point" 2>/dev/null || true
    fi
    
    # Remove from active mounts
    grep -v "^$original_file$" "$MOUNTS_FILE" > "$MOUNTS_FILE.tmp" 2>/dev/null || true
    mv "$MOUNTS_FILE.tmp" "$MOUNTS_FILE"
}

# Scan for existing journal files and mount them
initial_scan() {
    log "Scanning for existing journal files..."
    while IFS= read -r watch_dir; do
        [ -d "$watch_dir" ] || continue
        find "$watch_dir" -name "*.bigedit-journal" -type f 2>/dev/null | while read -r journal; do
            start_mount "$journal"
        done
    done < "$WATCH_DIRS_FILE"
}

# Watch for new journal files using inotifywait
watch_journals() {
    log "Watching for journal file changes..."
    
    # Build list of directories to watch
    local watch_args=()
    while IFS= read -r watch_dir; do
        [ -d "$watch_dir" ] && watch_args+=("$watch_dir")
    done < "$WATCH_DIRS_FILE"
    
    if [ ${#watch_args[@]} -eq 0 ]; then
        log "No directories to watch"
        return
    fi
    
    # Use inotifywait if available, otherwise poll
    if command -v inotifywait &>/dev/null; then
        inotifywait -m -r -e create -e delete -e moved_to -e moved_from \
            --include '\.bigedit-journal$' "${watch_args[@]}" 2>/dev/null | \
        while read -r dir event file; do
            local journal_path="$dir$file"
            case "$event" in
                CREATE*|MOVED_TO*)
                    start_mount "$journal_path"
                    ;;
                DELETE*|MOVED_FROM*)
                    # Journal deleted, stop mount
                    local journal_basename=$(basename "$journal_path")
                    local base="${journal_basename%.bigedit-journal}"
                    base="${base#.}"
                    local original_file="$(dirname "$journal_path")/$base"
                    stop_mount "$original_file"
                    ;;
            esac
        done
    else
        # Fallback: poll every 30 seconds
        log "inotifywait not found, falling back to polling"
        while true; do
            initial_scan
            sleep 30
        done
    fi
}

# Cleanup on exit
cleanup() {
    log "Shutting down bigedit-watcher..."
    while IFS= read -r original_file; do
        stop_mount "$original_file"
    done < "$MOUNTS_FILE"
    rm -f "$MOUNTS_FILE"
}

trap cleanup EXIT

# Main
log "BigEdit Watcher starting..."
initial_scan
watch_journals
